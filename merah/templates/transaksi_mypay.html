{% extends 'base.html' %}

{% block navbar %}
    {% if user_role == 'Pekerja' %}
        {% include 'navbar_pekerja.html' %}
    {% else %}
        {% include 'navbar_pengguna.html' %}
    {% endif %}
{% endblock navbar %}

{% block content %}
<div class="container mx-auto px-6 py-12 max-w-lg">
    <!-- Card Wrapper -->
    <div class="bg-white shadow-lg rounded-lg p-6">
        <h1 class="text-xl font-semibold text-gray-800 text-center mb-6">Transaksi MyPay</h1>
        
        <form id="transaksiForm" method="post">
            {% csrf_token %}
            
            <!-- Kategori Transaksi -->
            <div class="mb-4">
                <label for="kategori" class="block text-gray-700 font-medium mb-2">Kategori Transaksi</label>
                <select id="kategori" name="kategori" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    <option value="">Pilih Kategori</option>
                    <option value="TopUp">Top Up MyPay</option>
                    {% if user_role == 'pengguna' %}
                    <option value="Payment">Pembayaran Jasa</option>
                    {% endif %}
                    <option value="Transfer">Transfer MyPay</option>
                    <option value="Withdrawal">Withdrawal</option>
                </select>
            </div>
            
            <!-- State 1: Top Up -->
            <div id="stateTopUp" class="hidden">
                <label for="nominal_topup" class="block text-gray-700 font-medium mb-2">Nominal Top Up</label>
                <input type="number" id="nominal_topup" name="nominal_topup" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
            </div>
            
            <!-- State 2: Payment -->
            <div id="statePayment" class="hidden">
                <label for="jasa" class="block text-gray-700 font-medium mb-2">Pilih Jasa</label>
                <select id="jasa" name="jasa" class="w-full border border-gray-300 rounded-md px-4 py-2 mb-4 focus:ring-2 focus:ring-blue-500">
                    <option value="">Pilih Jasa</option>
                    {% for jasa in list_jasa %}
                        <option value="{{ jasa.nama }}" data-totalbiaya="{{ jasa.totalbiaya }}">{{ jasa.nama }}</option>
                    {% endfor %}
                </select>
                <label for="nominal_payment" class="block text-gray-700 font-medium mb-2">Jumlah Nominal</label>
                <input type="number" id="nominal_payment" name="nominal_payment" class="w-full bg-gray-100 border border-gray-300 rounded-md px-4 py-2" readonly>
            </div>
            
            <!-- State 3: Transfer -->
            <div id="stateTransfer" class="hidden">
                <label for="no_hp_tujuan" class="block text-gray-700 font-medium mb-2">No HP Tujuan</label>
                <input type="text" id="no_hp_tujuan" name="no_hp_tujuan" class="w-full border border-gray-300 rounded-md px-4 py-2 mb-4 focus:ring-2 focus:ring-blue-500">
                <label for="nominal_transfer" class="block text-gray-700 font-medium mb-2">Nominal Transfer</label>
                <input type="number" id="nominal_transfer" name="nominal_transfer" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
            </div>
            
            <!-- State 4: Withdrawal -->
            <div id="stateWithdrawal" class="hidden">
                <label for="bank" class="block text-gray-700 font-medium mb-2">Pilih Bank</label>
                <select id="bank" name="bank" class="w-full border border-gray-300 rounded-md px-4 py-2 mb-4 focus:ring-2 focus:ring-blue-500">
                    <option value="">Pilih Bank</option>
                    <option value="Bank A">Bank A</option>
                    <option value="Bank B">Bank B</option>
                    <option value="Bank C">Bank C</option>
                </select>
                <label for="nomor_rekening" class="block text-gray-700 font-medium mb-2">Nomor Rekening</label>
                <input type="text" id="nomor_rekening" name="nomor_rekening" class="w-full border border-gray-300 rounded-md px-4 py-2 mb-4 focus:ring-2 focus:ring-blue-500">
                <label for="nominal_withdrawal" class="block text-gray-700 font-medium mb-2">Nominal Withdrawal</label>
                <input type="number" id="nominal_withdrawal" name="nominal_withdrawal" class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mt-6 flex justify-center">
                <button type="submit" id="submitButton" class="px-6 py-2 bg-emerald-600 text-white font-medium rounded-md shadow hover:bg-blue-700 transition duration-200 hidden">Proses Transaksi</button>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript to handle form state display and button text -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const kategoriSelect = document.getElementById('kategori');
    const stateTopUp = document.getElementById('stateTopUp');
    const statePayment = document.getElementById('statePayment');
    const stateTransfer = document.getElementById('stateTransfer');
    const stateWithdrawal = document.getElementById('stateWithdrawal');
    const submitButton = document.getElementById('submitButton');
    const jasaSelect = document.getElementById('jasa');
    const nominalPayment = document.getElementById('nominal_payment');

    // Function to hide all state divs and the submit button
    function hideAllStates() {
        console.log('Hiding all states...');
        stateTopUp.classList.add('hidden');
        statePayment.classList.add('hidden');
        stateTransfer.classList.add('hidden');
        stateWithdrawal.classList.add('hidden');
        submitButton.classList.add('hidden');
    }

    // Function to show the selected state div and update button text
    function showState(selected) {
        console.log('Showing state:', selected);
        switch(selected) {
            case 'TopUp':
                stateTopUp.classList.remove('hidden');
                submitButton.textContent = 'Top Up';
                submitButton.classList.remove('hidden');
                break;
            case 'Payment':
            case 'Transfer':
            case 'Withdrawal':
                if (selected === 'Payment') {
                    statePayment.classList.remove('hidden');
                } else if (selected === 'Transfer') {
                    stateTransfer.classList.remove('hidden');
                } else if (selected === 'Withdrawal') {
                    stateWithdrawal.classList.remove('hidden');
                }
                submitButton.textContent = 'Bayar';
                submitButton.classList.remove('hidden');
                break;
            default:
                hideAllStates();
                break;
        }
    }

    // Event listener for kategori select change
    kategoriSelect.addEventListener('change', function() {
        console.log('Kategori select changed to:', this.value);
        hideAllStates();
        showState(this.value);
    });

    // Event listener for jasa select change to update nominal_payment
    jasaSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const totalBiaya = selectedOption.getAttribute('data-totalbiaya') || '';
        console.log('Selected Jasa Total Biaya:', totalBiaya);
        nominalPayment.value = totalBiaya;
    });

    // Optional: If you want to show state based on pre-selected value (e.g., after form submission)
    const initialSelected = kategoriSelect.value;
    if(initialSelected) {
        console.log('Initial selected value:', initialSelected);
        showState(initialSelected);
    }
});
</script>
{% endblock content %}